generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int                  @id @default(autoincrement())
  email                  String               @unique
  name                   String
  passwordHash           String
  type                   UserType
  tag                    String?
  enabled                Boolean              @default(true)
  pending                Boolean              @default(true)
  partnerDetails         Json?
  streamUserToken        String?              @unique
  streamUserId           String?              @unique
  allocationRead         Boolean              @default(false)
  allocationWrite        Boolean              @default(false)
  archivedRead           Boolean              @default(false)
  distributionRead       Boolean              @default(false)
  distributionWrite      Boolean              @default(false)
  isSuper                Boolean              @default(false)
  itemNotify             Boolean              @default(false)
  offerWrite             Boolean              @default(false)
  requestRead            Boolean              @default(false)
  requestWrite           Boolean              @default(false)
  shipmentRead           Boolean              @default(false)
  shipmentWrite          Boolean              @default(false)
  signoffWrite           Boolean              @default(false)
  supportNotify          Boolean              @default(false)
  supportRead            Boolean              @default(false)
  supportWrite           Boolean              @default(false)
  userRead               Boolean              @default(false)
  userWrite              Boolean              @default(false)
  wishlistRead           Boolean              @default(false)
  allocations            Allocation[]
  distributions          Distribution[]
  generalItemRequests    GeneralItemRequest[]
  notifications          Notification[]
  invite                 UserInvite?
  wishlists              Wishlist[]
  donorOfferVisibilities DonorOffer[]         @relation("DonorOfferToUser")
}

model UserInvite {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  expiration DateTime
  userId     Int      @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DonorOffer {
  id                      Int             @id @default(autoincrement())
  state                   DonorOfferState
  offerName               String
  donorName               String
  partnerResponseDeadline DateTime
  donorResponseDeadline   DateTime
  archivedAt              DateTime?
  items                   GeneralItem[]
  embeddings              ItemEmbedding[]
  partnerVisibilities     User[]          @relation("DonorOfferToUser")
}

model GeneralItem {
  id              Int                  @id @default(autoincrement())
  donorOfferId    Int
  title           String
  expirationDate  DateTime?            @db.Date
  unitType        String
  initialQuantity Int
  requestQuantity Int?
  description     String?
  type            ItemType?
  category        ItemCategory?
  weight          Decimal              @db.Decimal(10, 2)
  donorOffer      DonorOffer           @relation(fields: [donorOfferId], references: [id], onDelete: Cascade)
  requests        GeneralItemRequest[]
  embedding       ItemEmbedding?       @relation("GeneralItemEmbedding")
  items           LineItem[]
  wishlists       Wishlist[]

  @@unique([donorOfferId, title, expirationDate, unitType])
}

model LineItem {
  id                  Int          @id @default(autoincrement())
  donorName           String
  quantity            Int
  lotNumber           String
  palletNumber        String
  boxNumber           String
  unitPrice           Decimal      @db.Money
  maxRequestLimit     String?
  donorShippingNumber String?
  hfhShippingNumber   String?
  datePosted          DateTime     @default(now())
  ndc                 String?
  notes               String?
  allowAllocations    Boolean
  visible             Boolean
  gik                 Boolean
  generalItemId       Int?
  allocation          Allocation?
  generalItem         GeneralItem? @relation(fields: [generalItemId], references: [id], onDelete: Cascade)
}

model ItemEmbedding {
  id            Int                   @id @default(autoincrement())
  generalItemId Int?                  @unique
  wishlistId    Int?                  @unique
  donorOfferId  Int?
  embedding     Unsupported("vector")
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  donorOffer    DonorOffer?           @relation(fields: [donorOfferId], references: [id], onDelete: Cascade)
  generalItem   GeneralItem?          @relation("GeneralItemEmbedding", fields: [generalItemId], references: [id], onDelete: Cascade)
  wishlist      Wishlist?             @relation("WishlistEmbedding", fields: [wishlistId], references: [id], onDelete: Cascade)

  @@index([donorOfferId])
  @@index([generalItemId])
  @@index([wishlistId])
  @@map("ItemEmbeddings")
}

model GeneralItemRequest {
  id            Int              @id @default(autoincrement())
  generalItemId Int
  partnerId     Int
  quantity      Int
  finalQuantity Int              @default(0)
  comments      String?
  priority      RequestPriority?
  createdAt     DateTime         @default(now())
  generalItem   GeneralItem      @relation(fields: [generalItemId], references: [id], onDelete: Cascade)
  partner       User             @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([generalItemId, partnerId])
}

model Allocation {
  id             Int          @id @default(autoincrement())
  partnerId      Int?
  lineItemId     Int          @unique
  distributionId Int
  signOffId      Int?
  distribution   Distribution @relation(fields: [distributionId], references: [id], onDelete: Cascade)
  lineItem       LineItem     @relation(fields: [lineItemId], references: [id], onDelete: Cascade)
  partner        User?        @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  signOff        SignOff?     @relation(fields: [signOffId], references: [id], onDelete: Cascade)
}

model Distribution {
  id          Int          @id @default(autoincrement())
  partnerId   Int
  pending     Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  allocations Allocation[]
  partner     User         @relation(fields: [partnerId], references: [id])
}

model SignOff {
  id              Int          @id @default(autoincrement())
  staffMemberName String
  partnerId       Int
  partnerName     String
  date            DateTime
  signatureUrl    String?
  createdAt       DateTime     @default(now())
  allocations     Allocation[]
}

model ShippingStatus {
  id                  Int            @id @default(autoincrement())
  donorShippingNumber String?
  hfhShippingNumber   String?
  value               ShipmentStatus

  @@unique([donorShippingNumber, hfhShippingNumber])
}

model Wishlist {
  id            Int             @id @default(autoincrement())
  name          String
  quantity      Int?
  priority      RequestPriority
  lastUpdated   DateTime        @updatedAt
  comments      String
  partnerId     Int
  generalItemId Int?
  embedding     ItemEmbedding?  @relation("WishlistEmbedding")
  generalItem   GeneralItem?    @relation(fields: [generalItemId], references: [id])
  partner       User            @relation(fields: [partnerId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
}

model Notification {
  id          Int       @id @default(autoincrement())
  title       String
  action      String?
  actionText  String?
  dateCreated DateTime  @default(now())
  dateViewed  DateTime?
  userId      Int
  isDelivered Boolean   @default(false)
  payload     Json?
  template    String?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, dateViewed])
}

enum RequestPriority {
  LOW
  MEDIUM
  HIGH
}

enum UserType {
  STAFF
  PARTNER
}

enum DonorOfferState {
  UNFINALIZED
  FINALIZED
  ARCHIVED
}

enum ShipmentStatus {
  WAITING_ARRIVAL_FROM_DONOR
  LOAD_ON_SHIP_AIR
  ARRIVED_IN_HAITI
  CLEARED_CUSTOMS
  ARRIVED_AT_DEPO
  INVENTORIES
  READY_FOR_DISTRIBUTION
}

enum ItemType {
  MEDICATION
  MEDICATION_SUPPLEMENT
  NON_MEDICATION
}

enum ItemCategory {
  NEEDLES_SYRINGES
  ALZHEIMERS
  ANTIBIOTIC
  ANTIFUNGAL
  ANTIVIRAL
  BOOKS
  CANCER
  CARDIOVASCULAR
  CLOTHING_ACCESSORIES
  DENTAL
  DERMATOLOGY
  DEWORMER
  DIABETES
  EMERGENCY_RELIEF
  ENT
  FACILITY
  FLUID_REPLENISHMENT
  GASTROENTEROLOGY
  GENERAL
  HIV
  HORMONES
  HYGIENE
  LAB
  NEUROLOGICAL
  NUTRITION_SUPPLEMENTS
  OB_GYN
  OFFICE_SUPPLIES
  OPHTHALMOLOGY
  ORTHO
  PAIN_RELIEVERS
  PEDIATRIC
  PPE
  PSYCHIATRIC
  RECREATION
  RESPIRATORY
  STEROID
  SURGICAL
  THYROID
  URINARY_BOWEL
  VACCINES
  WASH
  WOUND_CARE
  X_RAY
}
